name: Build TFLite Support AAR (彻底修补googletest+预拉取)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-package:
    name: "Build TFLite Support AAR"
    runs-on: ubuntu-latest
    env:
      RELEASE_VERSION: "0.0.0-nightly-SNAPSHOT"
      ANDROID_API_LEVEL: "21"
      NDK_VERSION: "r27"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Bazel 5.1.1
        run: |
          wget -q https://github.com/bazelbuild/bazel/releases/download/5.1.1/bazel-5.1.1-linux-x86_64 -O bazel
          chmod +x bazel
          sudo mv bazel /usr/local/bin/bazel
          bazel --version

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 openjdk-17-jdk wget unzip
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> "$GITHUB_ENV"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK r27
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q android-ndk-${NDK_VERSION}-linux.zip -d /tmp
          NDK_PATH=/tmp/android-ndk-${NDK_VERSION}
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> "$GITHUB_ENV"
          ls -la $NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/clang* || exit 1
        env:
          NDK_VERSION: ${{ env.NDK_VERSION }}

      - name: Export Android environment
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> "$GITHUB_ENV"

      - name: Configure .bazelrc for NDK
        run: |
          echo "build --action_env=ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> .bazelrc

      - name: Verify Android paths
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME"
          echo "ANDROID_SDK_HOME=$ANDROID_SDK_HOME"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME"
          ls -la $ANDROID_HOME/platforms || true
          ls -la $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/clang* || true

      # 修补 tflite-support BUILD 文件
      - name: Patch tflite-support BUILD file
        run: |
          sed -i 's|//third_party/bazel_rules/rules_java/java:defs.bzl|@rules_java//java:defs.bzl|' tensorflow_lite_support/java/BUILD
          echo "Patched BUILD file"

      # 修补 tflite-support 的 third_party/repo.bzl
      - name: Patch third_party/repo.bzl
        run: |
          sed -i 's/\.to_list()//g' third_party/repo.bzl
          echo "Patched third_party/repo.bzl"

      # 克隆 TensorFlow 源码并应用所有必要修补
      - name: Clone and patch TensorFlow
        run: |
          git clone --recursive https://github.com/tensorflow/tensorflow.git tensorflow_src
          cd tensorflow_src
          git checkout 777924f5575e7e6e22e4f47be211c2a94f59c4f5
          git submodule update --init --recursive
          touch unused

          # 替换 HERMETIC_PYTHON_VERSION
          find . -type f -name "*.bzl" -exec sed -i 's/HERMETIC_PYTHON_VERSION/"3.12"/g' {} \;
          # 删除 python_version_repo 引用
          find . -type f -exec sed -i '/python_version_repo/d' {} \;
          # 删除 generate_api.bzl 加载
          find . -type f -exec sed -i '/load.*generate_api.bzl/d' {} \;
          # 删除 python_init_ 相关行
          find . -type f -exec sed -i '/python_init_/d' {} \;

          # 强制 NDK 版本为 27
          sed -i '/ndk_version =/c\    # ndk_version = 0  # commented out\n    ndk_version = 27' third_party/android/android_configure.bzl

          # 修复 vendored 路径问题
          sed -i '/ctx.symlink(ctx.path(ctx.attr._root).dirname.get_child(ctx.attr.path), ".")/c\
              # Patched to handle paths with slashes\n    path_parts = ctx.attr.path.split('\''/'\'')\n    p = ctx.path(ctx.attr._root).dirname\n    for part in path_parts:\n        p = p.get_child(part)\n    ctx.symlink(p, ".")' third_party/repo.bzl

          # 彻底删除所有 googletest_deps.bzl 加载行
          echo "Before patching googletest_deps.bzl:"
          grep -r "googletest_deps.bzl" . || echo "None found"
          find . -type f -name "*.bzl" -exec sed -i '/googletest_deps.bzl/d' {} \;
          find . -type f -name "*.bzl" -exec sed -i '/load.*googletest_deps.bzl/d' {} \;
          find . -type f -name "*.bzl" -exec sed -i '/googletest_deps.bzl/s/.*/# removed/' {} \;  # 保险
          echo "After patching:"
          grep -r "googletest_deps.bzl" . || echo "All occurrences removed"

          cd ..

      # 创建 Android 平台定义（虽然 Bazel 5 可能不需要，但保留无害）
      - name: Create platform definitions
        run: |
          mkdir -p platform
          cat > platform/BUILD <<'EOF'
          platform(
              name = "android_arm64_v8a",
              constraint_values = [
                  "@platforms//os:android",
                  "@platforms//cpu:arm64",
              ],
          )
          platform(
              name = "android_armeabi_v7a",
              constraint_values = [
                  "@platforms//os:android",
                  "@platforms//cpu:armv7",
              ],
          )
          platform(
              name = "android_x86",
              constraint_values = [
                  "@platforms//os:android",
                  "@platforms//cpu:x86_32",
              ],
          )
          platform(
              name = "android_x86_64",
              constraint_values = [
                  "@platforms//os:android",
                  "@platforms//cpu:x86_64",
              ],
          )
          EOF

      # 预拉取依赖并应用覆盖
      - name: Fetch dependencies with override
        run: |
          bazel fetch //tensorflow_lite_support/java:tensorflow-lite-support \
            --config=android_arm64 \
            --fat_apk_cpu=arm64-v8a,armeabi-v7a,x86,x86_64 \
            --override_repository=org_tensorflow=$(pwd)/tensorflow_src \
            --curses=no

      - name: Build TFLite Support AAR
        run: |
          BUILD_FLAGS=(
            "-c" "opt"
            "--cxxopt=--std=c++17"
            "--config=android_arm64"
            "--fat_apk_cpu=arm64-v8a,armeabi-v7a,x86,x86_64"
            "--define=android_dexmerger_tool=d8_dexmerger"
            "--define=android_incremental_dexing_tool=d8_dexbuilder"
            "--repo_env=HERMETIC_PYTHON_VERSION=3.12"
            "--show_timestamps"
            "--incompatible_enable_android_toolchain_resolution=false"
            "--linkopt=-Wl,--undefined-version"
            "--linkopt=-Wl,--allow-multiple-definition"
            "--copt=-D__ANDROID__"
            "--copt=-UINTEL_MKL"
            "--override_repository=org_tensorflow=$(pwd)/tensorflow_src"
          )
          bazel build //tensorflow_lite_support/java:tensorflow-lite-support "${BUILD_FLAGS[@]}" \
            --verbose_failures

      - name: Locate AAR file
        id: locate-aar
        run: |
          AAR_PATH=$(find bazel-bin/tensorflow_lite_support/java -name "*.aar" | head -n 1)
          if [ -z "$AAR_PATH" ]; then
            echo "Error: AAR not found!"
            exit 1
          fi
          echo "aar-path=$AAR_PATH" >> "$GITHUB_OUTPUT"
          echo "Found AAR at $AAR_PATH"

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-android-aar-all-arch
          path: ${{ steps.locate-aar.outputs.aar-path }}
          if-no-files-found: error
