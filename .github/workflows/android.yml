name: Build tflite-support AAR (Docker with Java 8 for SDK)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tflite-support
        uses: actions/checkout@v4
        with:
          repository: anonyein/tflite-support
          ref: master
          path: tflite-support

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run build in TensorFlow devel container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tflite-support:/workspace \
            -w /workspace \
            tensorflow/tensorflow:devel \
            bash -c "
              set -ex

              # 安装 Java 17（主环境）和 Java 8（用于 sdkmanager）
              apt-get update && apt-get install -y openjdk-17-jdk openjdk-8-jre-headless wget unzip

              # 设置默认 Java 为 17（供 Bazel 使用）
              export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
              export PATH=\$JAVA_HOME/bin:\$PATH

              # 安装 Android SDK 和 NDK
              mkdir -p /opt/android/sdk
              cd /opt/android/sdk
              wget -q https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip
              unzip -q sdk-tools-linux-4333796.zip
              rm sdk-tools-linux-4333796.zip
              export ANDROID_HOME=/opt/android/sdk
              export ANDROID_SDK_HOME=\$ANDROID_HOME
              export PATH=\$ANDROID_HOME/tools:\$ANDROID_HOME/tools/bin:\$ANDROID_HOME/platform-tools:\$PATH

              # 使用 Java 8 运行 sdkmanager
              export JAVA8_HOME=/usr/lib/jvm/java-8-openjdk-amd64
              (
                export JAVA_HOME=\$JAVA8_HOME
                export PATH=\$JAVA8_HOME/bin:\$PATH
                yes | sdkmanager --licenses || true
                sdkmanager \"platforms;android-21\" \"build-tools;30.0.3\"
              )

              # 安装 NDK r27 并重命名为纯数字目录
              cd /opt
              wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
              unzip -q android-ndk-r27-linux.zip
              mv android-ndk-r27 android-ndk-27
              rm android-ndk-r27-linux.zip
              export ANDROID_NDK_HOME=/opt/android-ndk-27
              export PATH=\$ANDROID_NDK_HOME:\$PATH
              echo \"Pkg.Revision = 27.0.0\" > \$ANDROID_NDK_HOME/source.properties

              export ANDROID_API_LEVEL=21
              export ANDROID_NDK_API_LEVEL=27
              export ANDROID_BUILD_TOOLS_VERSION=30.0.3
              export ANDROID_SDK_API_LEVEL=21

              cd /workspace

              # 克隆 TensorFlow（与 WORKSPACE 中一致）
              git clone --recursive https://github.com/tensorflow/tensorflow.git tensorflow_src
              cd tensorflow_src
              git checkout 777924f5575e7e6e22e4f47be211c2a94f59c4f5
              git submodule update --init --recursive

              # 创建 unused 文件（修复 vendoring）
              touch unused
              if [ -d xla ]; then touch xla/unused; fi

              # 彻底删除所有对 python_version_repo 的引用
              find . -type f -name '*.bzl' -exec sed -i '/python_version_repo/d' {} \;
              # 删除 load generate_api.bzl 的行
              find . -type f -name '*.bzl' -exec sed -i '/load.*generate_api.bzl/d' {} \;
              # 替换 HERMETIC_PYTHON_VERSION 为硬编码字符串
              find . -type f -name '*.bzl' -exec sed -i 's/HERMETIC_PYTHON_VERSION/\"3.12\"/g' {} \;

              # 特别修补 python_configure.bzl（如果存在）
              if [ -f xla/third_party/py/python_configure.bzl ]; then
                sed -i '/@python_version_repo/d' xla/third_party/py/python_configure.bzl
              fi

              # 修补 repo.bzl 中的 vendoring 路径
              sed -i '/ctx.symlink(ctx.path(ctx.attr._root).dirname.get_child(ctx.attr.path), \".\")/c\
                  # Patched to handle paths with slashes\n    path_parts = ctx.attr.path.split('/')\n    p = ctx.path(ctx.attr._root).dirname\n    for part in path_parts:\n        p = p.get_child(part)\n    ctx.symlink(p, \".\")' third_party/repo.bzl || true

              cd ..

              # 修补 tflite-support 自己的文件
              sed -i 's|//third_party/bazel_rules/rules_java/java:defs.bzl|@rules_java//java:defs.bzl|' tensorflow_lite_support/java/BUILD
              sed -i 's/\.to_list()//g' third_party/repo.bzl

              # 执行 Bazel 构建
              bazel build //tensorflow_lite_support/java:tensorflow-lite-support \
                -c opt \
                --fat_apk_cpu=arm64-v8a,armeabi-v7a,x86,x86_64 \
                --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \
                --override_repository=org_tensorflow=\$(pwd)/tensorflow_src \
                --verbose_failures
            "

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-aar
          path: tflite-support/bazel-bin/tensorflow_lite_support/java/*.aar
