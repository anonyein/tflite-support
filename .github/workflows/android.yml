name: Build TFLite Support AAR using Official Docker Image

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-aar:
    name: "Build TFLite Support AAR in Docker"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # 下载官方用于构建 Android 的 Dockerfile
      - name: Download TensorFlow Lite Android Dockerfile
        run: |
          curl -O https://raw.githubusercontent.com/tensorflow/tensorflow/master/tensorflow/tools/dockerfiles/tflite-android.Dockerfile

      # 构建 Docker 镜像
      - name: Build Docker image
        run: |
          docker build . -t tflite-builder -f tflite-android.Dockerfile

      # 在容器内运行构建，挂载当前目录到 /host_dir
      - name: Run build inside container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/host_dir \
            -w /host_dir \
            -e ANDROID_HOME=/opt/android/sdk \
            -e ANDROID_SDK_HOME=/opt/android/sdk \
            -e ANDROID_NDK_HOME=/opt/android/sdk/ndk-bundle \
            -e ANDROID_API_LEVEL=21 \
            -e ANDROID_BUILD_TOOLS_VERSION=30.0.3 \
            tflite-builder \
            bash -c "
              # 接受 Android SDK 许可证
              yes | sdkmanager --licenses > /dev/null 2>&1 || true

              # 配置 TensorFlow（如果需要）
              if [ -f configure.py ]; then
                export TF_NEED_ANDROID=1
                export TF_SET_ANDROID_WORKSPACE=1
                yes '' | python3 configure.py
              fi

              # 创建 Android 平台定义（如果不存在）
              mkdir -p platform
              cat > platform/BUILD <<'EOF'
              platform(
                  name = \"android_arm64_v8a\",
                  constraint_values = [
                      \"@platforms//os:android\",
                      \"@platforms//cpu:arm64\",
                  ],
              )
              platform(
                  name = \"android_armeabi_v7a\",
                  constraint_values = [
                      \"@platforms//os:android\",
                      \"@platforms//cpu:armv7\",
                  ],
              )
              platform(
                  name = \"android_x86\",
                  constraint_values = [
                      \"@platforms//os:android\",
                      \"@platforms//cpu:x86_32\",
                  ],
              )
              platform(
                  name = \"android_x86_64\",
                  constraint_values = [
                      \"@platforms//os:android\",
                      \"@platforms//cpu:x86_64\",
                  ],
              )
              EOF

              # 计算 Python 库路径
              PYTHON_LIB_PATH=\$(python3 -c 'import site; print(site.getsitepackages()[0])')

              # 构建 AAR
              bazel build //tensorflow_lite_support/java:tensorflow-lite-support \
                --android_platforms=//platform:android_arm64_v8a,//platform:android_armeabi_v7a,//platform:android_x86,//platform:android_x86_64 \
                --repo_env=HERMETIC_PYTHON_VERSION=3.12 \
                --repo_env=PYTHON_BIN_PATH=/usr/bin/python3 \
                --repo_env=PYTHON_LIB_PATH=\$PYTHON_LIB_PATH \
                --repo_env=TF_PYTHON_VERSION=3.12 \
                --curses=no \
                --show_timestamps \
                --verbose_failures \
                --noenable_bzlmod
            "

      # 定位生成的 AAR 文件
      - name: Locate AAR file
        id: locate-aar
        run: |
          AAR_PATH=$(find bazel-bin/tensorflow_lite_support/java -name "*.aar" | head -n 1)
          if [ -z "$AAR_PATH" ]; then
            echo "Error: AAR not found!"
            exit 1
          fi
          echo "aar-path=$AAR_PATH" >> "$GITHUB_OUTPUT"
          echo "Found AAR at $AAR_PATH"

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-android-aar-all-arch
          path: ${{ steps.locate-aar.outputs.aar-path }}
          if-no-files-found: error
