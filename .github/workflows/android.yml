name: Build TFLite Support Android AAR

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 允许手动触发

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-package:
    name: "Build TFLite Support AAR"
    runs-on: ubuntu-latest
    env:
      # 可指定 Java 版本（默认已安装 11/17，此处显式声明）
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive  # 如果项目有子模块则拉取

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          # 根据项目 .bazelversion 自动选择版本，也可显式指定
          bazel-version: 7.0.0

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # 设置 Android 环境变量供 Bazel 使用
      - name: Export Android environment
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"
          # NDK 可能不是必须，但为了完整设置（某些依赖可能需要）
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk-bundle" >> "$GITHUB_ENV"
        # 注意：setup-android 默认安装的 NDK 版本可能不是最新的，但不影响纯 Java 构建

      - name: Verify Android SDK
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME"
          ls -la $ANDROID_HOME/platforms || true

      # 可选：缓存 Bazel 外部依赖以加速后续构建
      - name: Cache Bazel external dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/bazel
          key: ${{ runner.os }}-bazel-${{ hashFiles('WORKSPACE', 'MODULE.bazel', '**/BUILD') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      # 执行构建：目标是 //tensorflow_lite_support/java:tensorflow-lite-support
      - name: Build TFLite Support AAR
        run: |
          bazel build //tensorflow_lite_support/java:tensorflow-lite-support \
            --curses=no \
            --show_timestamps \
            --verbose_failures
        # 可以添加 --config=android 等配置，但此处默认使用 host 工具链即可

      # 定位生成的 AAR 文件（可能为 libtensorflowlite_support.aar）
      - name: Locate AAR file
        id: locate-aar
        run: |
          # 查找 bazel-bin 下的 .aar 文件
          AAR_PATH=$(find bazel-bin/tensorflow_lite_support/java -name "*.aar" | head -n 1)
          if [ -z "$AAR_PATH" ]; then
            echo "Error: AAR not found!"
            exit 1
          fi
          echo "aar-path=$AAR_PATH" >> "$GITHUB_OUTPUT"
          echo "Found AAR at $AAR_PATH"

      # 上传构建产物
      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-android-aar
          path: ${{ steps.locate-aar.outputs.aar-path }}
          if-no-files-found: error

      # 可选：列出 bazel-bin 内容供调试
      - name: List output files
        run: find bazel-bin/tensorflow_lite_support/java -type f || true
