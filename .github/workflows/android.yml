name: Build tflite-support Android AAR (官方指南)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Android SDK 和 NDK 环境变量（供 configure 脚本使用）
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_HOME: /usr/local/lib/android/sdk
      ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.0.0   # 使用 NDK 27
      ANDROID_SDK_API_LEVEL: "23"        # 官方推荐 23 或更高
      ANDROID_NDK_API_LEVEL: "21"        # 官方推荐 21（最低支持）
      ANDROID_BUILD_TOOLS_VERSION: "30.0.3"
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

    steps:
      - name: Checkout tflite-support repository
        uses: actions/checkout@v4
        with:
          repository: anonyein/tflite-support
          ref: master
          path: tflite-support

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Bazelisk
        run: npm install -g @bazel/bazelisk

      - name: Set up Android SDK and NDK
        run: |
          # 安装命令行工具
          mkdir -p $ANDROID_HOME/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip -d $ANDROID_HOME/cmdline-tools
          mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin

          yes | sdkmanager --licenses
          sdkmanager "platforms;android-$ANDROID_SDK_API_LEVEL" "build-tools;$ANDROID_BUILD_TOOLS_VERSION"

          # 安装 NDK 27
          wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
          unzip -q android-ndk-r27-linux.zip -d /tmp
          sudo mv /tmp/android-ndk-r27 $ANDROID_NDK_HOME

      - name: Clone TensorFlow (required by tflite-support WORKSPACE)
        working-directory: tflite-support
        run: |
          git clone --recursive https://github.com/tensorflow/tensorflow.git tensorflow_src
          cd tensorflow_src
          # 切换到 tflite-support WORKSPACE 中指定的 commit（可从 WORKSPACE 文件中提取）
          git checkout 777924f5575e7e6e22e4f47be211c2a94f59c4f5
          git submodule update --init --recursive

      - name: Configure TensorFlow (生成 .tf_configure.bazelrc)
        working-directory: tflite-support/tensorflow_src
        run: |
          export TF_NEED_ANDROID=1
          export TF_SET_ANDROID_WORKSPACE=1
          # 环境变量已经在上层设置，configure 脚本会自动读取
          yes '' | python3 configure.py

      - name: Build tflite-support AAR
        working-directory: tflite-support
        run: |
          # 使用官方推荐的构建命令，指定目标架构
          bazel build //tensorflow_lite_support/java:tensorflow-lite-support \
            -c opt \
            --fat_apk_cpu=arm64-v8a,armeabi-v7a,x86,x86_64 \
            --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \
            --override_repository=org_tensorflow=$(pwd)/tensorflow_src \
            --verbose_failures

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-aar
          path: tflite-support/bazel-bin/tensorflow_lite_support/java/*.aar
