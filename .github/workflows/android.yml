name: Build TFLite Support AAR (Nuclear Option)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-aar:
    name: "Build TFLite Support AAR"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk openjdk-8-jre-headless wget unzip
          sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java

      - name: Install Bazel 5.1.1
        run: |
          wget -q https://github.com/bazelbuild/bazel/releases/download/5.1.1/bazel-5.1.1-linux-x86_64 -O bazel
          chmod +x bazel
          sudo mv bazel /usr/local/bin/bazel
          bazel --version

      - name: Install Android SDK and NDK
        run: |
          export JAVA8_HOME=/usr/lib/jvm/java-8-openjdk-amd64
          mkdir -p $HOME/android/sdk
          cd $HOME/android/sdk
          wget -q https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip
          unzip -q sdk-tools-linux-4333796.zip
          rm sdk-tools-linux-4333796.zip
          export ANDROID_HOME=$HOME/android/sdk
          export PATH=$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools:$PATH
          (
            export JAVA_HOME=$JAVA8_HOME
            export PATH=$JAVA8_HOME/bin:$PATH
            yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses || true
            $ANDROID_HOME/tools/bin/sdkmanager "platforms;android-21" "build-tools;30.0.3"
          )
          cd $HOME
          wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
          unzip -q android-ndk-r27-linux.zip
          mv android-ndk-r27 android-ndk-27
          rm android-ndk-r27-linux.zip
          export ANDROID_NDK_HOME=$HOME/android-ndk-27
          echo "Pkg.Revision = 27.0.0" > $ANDROID_NDK_HOME/source.properties
          echo "Pkg.Desc = Android NDK" >> $ANDROID_NDK_HOME/source.properties
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "ANDROID_API_LEVEL=21" >> $GITHUB_ENV
          echo "ANDROID_NDK_API_LEVEL=27" >> $GITHUB_ENV
          echo "ANDROID_BUILD_TOOLS_VERSION=30.0.3" >> $GITHUB_ENV
          echo "ANDROID_SDK_API_LEVEL=21" >> $GITHUB_ENV
          echo "$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools:$ANDROID_NDK_HOME" >> $GITHUB_PATH

      - name: Clone and brutally patch TensorFlow
        run: |
          git clone --recursive https://github.com/tensorflow/tensorflow.git tensorflow_src
          cd tensorflow_src
          git checkout 777924f5575e7e6e22e4f47be211c2a94f59c4f5
          git submodule update --init --recursive
          touch unused

          # Delete all references to python_version_repo
          find . -type f -exec sed -i '/python_version_repo/d' {} \;
          # Delete all loads of generate_api.bzl (which indirectly references python_version_repo)
          find . -type f -exec sed -i '/load.*generate_api.bzl/d' {} \;
          # Delete any lines containing python_init_ (in case we missed some)
          find . -type f -exec sed -i '/python_init_/d' {} \;

          # Apply other necessary patches
          sed -i 's/ndk_version =.*/    ndk_version = 27/' third_party/android/android_configure.bzl
          sed -i '/ctx.symlink(ctx.path(ctx.attr._root).dirname.get_child(ctx.attr.path), ".")/c\
              # Patched to handle paths with slashes\n    path_parts = ctx.attr.path.split('\''/'\'')\n    p = ctx.path(ctx.attr._root).dirname\n    for part in path_parts:\n        p = p.get_child(part)\n    ctx.symlink(p, ".")' third_party/repo.bzl
          cd ..

      - name: Patch tflite-support files
        run: |
          sed -i 's|//third_party/bazel_rules/rules_java/java:defs.bzl|@rules_java//java:defs.bzl|' tensorflow_lite_support/java/BUILD
          sed -i 's/\.to_list()//g' third_party/repo.bzl

      - name: Create platform definitions
        run: |
          mkdir -p platform
          cat > platform/BUILD <<'EOF'
          platform(
              name = "android_arm64_v8a",
              constraint_values = [
                  "@platforms//os:android",
                  "@platforms//cpu:arm64",
              ],
          )
          platform(
              name = "android_armeabi_v7a",
              constraint_values = [
                  "@platforms//os:android",
                  "@platforms//cpu:armv7",
              ],
          )
          platform(
              name = "android_x86",
              constraint_values = [
                  "@platforms//os:android",
                  "@platforms//cpu:x86_32",
              ],
          )
          platform(
              name = "android_x86_64",
              constraint_values = [
                  "@platforms//os:android",
                  "@platforms//cpu:x86_64",
              ],
          )
          EOF

      - name: Configure TensorFlow (skip python config)
        run: |
          cd tensorflow_src
          export TF_NEED_ANDROID=1
          export TF_SET_ANDROID_WORKSPACE=1
          export PYTHON_BIN_PATH=/usr/bin/python3
          export PYTHON_LIB_PATH=$(python3 -c 'import site; print(site.getsitepackages()[0])')
          export TF_NEED_CLANG=0
          export TF_NEED_CUDA=0
          export TF_NEED_ROCM=0
          export TF_NEED_TENSORRT=0
          export TF_DOWNLOAD_CLANG=0
          yes '' | python3 configure.py
          cd ..

      - name: Build AAR
        run: |
          bazel build //tensorflow_lite_support/java:tensorflow-lite-support \
            --android_platforms=//platform:android_arm64_v8a,//platform:android_armeabi_v7a,//platform:android_x86,//platform:android_x86_64 \
            --override_repository=org_tensorflow=$(pwd)/tensorflow_src \
            --curses=no \
            --show_timestamps \
            --verbose_failures

      - name: Locate AAR file
        id: locate-aar
        run: |
          AAR_PATH=$(find bazel-bin/tensorflow_lite_support/java -name "*.aar" | head -n 1)
          if [ -z "$AAR_PATH" ]; then
            echo "Error: AAR not found!"
            exit 1
          fi
          echo "aar-path=$AAR_PATH" >> "$GITHUB_OUTPUT"
          echo "Found AAR at $AAR_PATH"

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-android-aar-all-arch
          path: ${{ steps.locate-aar.outputs.aar-path }}
          if-no-files-found: error
