name: Build tflite-support Android AAR (终极方案)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-aar:
    name: "Build tflite-support AAR"
    runs-on: ubuntu-latest
    env:
      RELEASE_VERSION: "0.0.0-nightly-SNAPSHOT"
      ANDROID_API_LEVEL: "21"
      NDK_VERSION: "r27"

    steps:
      - name: Checkout tflite-support repository
        uses: actions/checkout@v4
        with:
          path: tflite-support
          fetch-depth: 0
          submodules: recursive

      - name: Setup Bazel 5.1.1
        run: |
          wget -q https://github.com/bazelbuild/bazel/releases/download/5.1.1/bazel-5.1.1-linux-x86_64 -O bazel
          chmod +x bazel
          sudo mv bazel /usr/local/bin/bazel
          bazel --version

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 openjdk-17-jdk wget unzip
          echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> "$GITHUB_ENV"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK r27
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q android-ndk-${NDK_VERSION}-linux.zip -d /tmp
          echo "ANDROID_NDK_HOME=/tmp/android-ndk-${NDK_VERSION}" >> "$GITHUB_ENV"
        env:
          NDK_VERSION: ${{ env.NDK_VERSION }}

      - name: Export Android environment
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"

      - name: Create build script
        run: |
          cat > build.sh <<'EOF'
          #!/bin/bash
          set -ex

          # 设置 Android 环境变量
          export ANDROID_NDK_HOME=/tmp/android-ndk-r27
          export ANDROID_HOME=$ANDROID_HOME
          export ANDROID_SDK_HOME=$ANDROID_HOME
          export ANDROID_API_LEVEL=21
          export ANDROID_NDK_API_LEVEL=27
          export ANDROID_BUILD_TOOLS_VERSION=30.0.3
          export ANDROID_SDK_API_LEVEL=21

          cd tflite-support

          # 修补 tflite-support 自身的 BUILD 文件 (load 路径错误)
          sed -i 's|//third_party/bazel_rules/rules_java/java:defs.bzl|@rules_java//java:defs.bzl|' tensorflow_lite_support/java/BUILD
          # 修补 tflite-support 自身的 repo.bzl (to_list 错误)
          sed -i 's/\.to_list()//g' third_party/repo.bzl

          # 克隆 TensorFlow (tflite-support 依赖的版本)
          git clone --recursive https://github.com/tensorflow/tensorflow.git tensorflow_src
          cd tensorflow_src
          # 切换到 tflite-support WORKSPACE 中指定的 commit
          git checkout 777924f5575e7e6e22e4f47be211c2a94f59c4f5
          git submodule update --init --recursive

          # 创建 unused 文件，解决一些旧版 vendoring 问题
          touch unused

          # --- 核心修复: 在 TensorFlow WORKSPACE 中彻底禁用 Hermetic Python ---
          # 注释掉所有 python_init_* 相关的行
          sed -i '/python_init_rules/ s/^/# /' WORKSPACE
          sed -i '/python_init_repositories/ s/^/# /' WORKSPACE
          sed -i '/python_init_toolchains/ s/^/# /' WORKSPACE
          sed -i '/python_init_pip/ s/^/# /' WORKSPACE
          sed -i '/install_deps/ s/^/# /' WORKSPACE
          # 注释掉可能加载 python_version_repo 的其他行
          sed -i '/python_version_repo/ s/^/# /' tensorflow/workspace3.bzl 2>/dev/null || true
          sed -i '/python_version_repo/ s/^/# /' tensorflow/workspace.bzl 2>/dev/null || true

          # 确保 NDK 版本正确 (可选，但保留无害)
          sed -i 's/ndk_version =.*/    ndk_version = 27/' third_party/android/android_configure.bzl

          # 修复 repo.bzl 中的路径问题 (保留，以防万一)
          sed -i '/ctx.symlink(ctx.path(ctx.attr._root).dirname.get_child(ctx.attr.path), ".")/c\
              # Patched to handle paths with slashes\n    path_parts = ctx.attr.path.split('\''/'\'')\n    p = ctx.path(ctx.attr._root).dirname\n    for part in path_parts:\n        p = p.get_child(part)\n    ctx.symlink(p, ".")' third_party/repo.bzl
          cd ..

          # 构建最终的 AAR
          bazel build //tensorflow_lite_support/java:tensorflow-lite-support \
            --config=android_arm64 \
            --fat_apk_cpu=arm64-v8a,armeabi-v7a,x86,x86_64 \
            --incompatible_enable_android_toolchain_resolution=false \
            --linkopt=-Wl,--undefined-version \
            --linkopt=-Wl,--allow-multiple-definition \
            --copt=-D__ANDROID__ \
            --copt=-UINTEL_MKL \
            --override_repository=org_tensorflow=$(pwd)/tensorflow_src \
            --verbose_failures

          # 准备输出目录
          mkdir -p gen
          VERSION=${RELEASE_VERSION:-0.0.0-nightly-SNAPSHOT}
          find bazel-bin/ -name "*.aar" -exec cp {} gen/ \;
          EOF
          chmod +x build.sh

      - name: Run build script
        run: ./build.sh
        env:
          RELEASE_VERSION: ${{ env.RELEASE_VERSION }}

      - name: Upload AAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-android-aars
          path: tflite-support/gen/
          if-no-files-found: error
