name: Build TFLite Support AAR using Docker

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-aar:
    name: "Build TFLite Support AAR"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # 创建 Dockerfile 用于构建包含 Android SDK 和 NDK 的镜像
      - name: Create Dockerfile
        run: |
          cat > Dockerfile.android <<'EOF'
          FROM tensorflow/tensorflow:devel

          # Install required packages, including OpenJDK 8 (for sdkmanager compatibility)
          RUN apt-get update && apt-get install -y openjdk-8-jdk wget unzip && \
              apt-get clean && rm -rf /var/lib/apt/lists/*

          # Set JAVA_HOME to Java 8
          ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64

          # Install Android SDK tools (older version that works with Java 8)
          ENV ANDROID_SDK_VERSION 4333796
          ENV ANDROID_HOME /opt/android/sdk
          RUN mkdir -p ${ANDROID_HOME} && \
              wget -q https://dl.google.com/android/repository/sdk-tools-linux-${ANDROID_SDK_VERSION}.zip && \
              unzip -q sdk-tools-linux-${ANDROID_SDK_VERSION}.zip -d ${ANDROID_HOME} && \
              rm sdk-tools-linux-${ANDROID_SDK_VERSION}.zip

          ENV PATH ${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/tools/bin:${ANDROID_HOME}/platform-tools

          # Install Android NDK r23c
          ENV ANDROID_NDK_VERSION r23c
          RUN wget -q https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip && \
              unzip -q android-ndk-${ANDROID_NDK_VERSION}-linux.zip -d /opt && \
              rm android-ndk-${ANDROID_NDK_VERSION}-linux.zip

          # Create a symlink with numeric version to avoid "r23c" string in path
          RUN ln -s /opt/android-ndk-${ANDROID_NDK_VERSION} /opt/android-ndk-23
          ENV ANDROID_NDK_HOME /opt/android-ndk-23
          ENV PATH ${PATH}:${ANDROID_NDK_HOME}

          # Create source.properties file for NDK (correct numeric version for r23c)
          RUN echo "Pkg.Revision = 23.2.8568313" > ${ANDROID_NDK_HOME}/source.properties && \
              echo "Pkg.Desc = Android NDK" >> ${ANDROID_NDK_HOME}/source.properties

          # Set Android API level (as integer) and build tools version
          ENV ANDROID_API_LEVEL 21
          ENV ANDROID_NDK_API_LEVEL 23
          ENV ANDROID_BUILD_TOOLS_VERSION 30.0.3
          EOF

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with Android SDK
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.android
          push: false
          load: true
          tags: tflite-builder:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 在容器内运行构建
      - name: Run build inside container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            tflite-builder:latest \
            bash -c "
              # 接受 Android SDK 许可证
              yes | sdkmanager --licenses || true
              sdkmanager \"platforms;android-21\" \"build-tools;30.0.3\"

              # 如果存在 configure.py 则运行
              if [ -f configure.py ]; then
                export TF_NEED_ANDROID=1
                export TF_SET_ANDROID_WORKSPACE=1
                yes '' | python3 configure.py
              fi

              # 创建 Android 平台定义（使用 printf 避免 heredoc 问题）
              mkdir -p platform
              printf '%s\n' \\
                'platform(' \\
                '    name = \"android_arm64_v8a\",' \\
                '    constraint_values = [' \\
                '        \"@platforms//os:android\",' \\
                '        \"@platforms//cpu:arm64\",' \\
                '    ],' \\
                ')' \\
                'platform(' \\
                '    name = \"android_armeabi_v7a\",' \\
                '    constraint_values = [' \\
                '        \"@platforms//os:android\",' \\
                '        \"@platforms//cpu:armv7\",' \\
                '    ],' \\
                ')' \\
                'platform(' \\
                '    name = \"android_x86\",' \\
                '    constraint_values = [' \\
                '        \"@platforms//os:android\",' \\
                '        \"@platforms//cpu:x86_32\",' \\
                '    ],' \\
                ')' \\
                'platform(' \\
                '    name = \"android_x86_64\",' \\
                '    constraint_values = [' \\
                '        \"@platforms//os:android\",' \\
                '        \"@platforms//cpu:x86_64\",' \\
                '    ],' \\
                ')' > platform/BUILD

              # 计算 Python 库路径
              PYTHON_LIB_PATH=\$(python3 -c 'import site; print(site.getsitepackages()[0])')

              # 执行 Bazel 构建
              bazel build //tensorflow_lite_support/java:tensorflow-lite-support \
                --android_platforms=//platform:android_arm64_v8a,//platform:android_armeabi_v7a,//platform:android_x86,//platform:android_x86_64 \
                --repo_env=HERMETIC_PYTHON_VERSION=3.12 \
                --repo_env=PYTHON_BIN_PATH=/usr/bin/python3 \
                --repo_env=PYTHON_LIB_PATH=\$PYTHON_LIB_PATH \
                --repo_env=TF_PYTHON_VERSION=3.12 \
                --curses=no \
                --show_timestamps \
                --verbose_failures
            "

      # 定位生成的 AAR 文件
      - name: Locate AAR file
        id: locate-aar
        run: |
          AAR_PATH=$(find bazel-bin/tensorflow_lite_support/java -name "*.aar" | head -n 1)
          if [ -z "$AAR_PATH" ]; then
            echo "Error: AAR not found!"
            exit 1
          fi
          echo "aar-path=$AAR_PATH" >> "$GITHUB_OUTPUT"
          echo "Found AAR at $AAR_PATH"

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-android-aar-all-arch
          path: ${{ steps.locate-aar.outputs.aar-path }}
          if-no-files-found: error
