name: Build TFLite Support Android AAR

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-package:
    name: "Build TFLite Support AAR"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          bazel-version: 7.0.0

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Export Android environment
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"

      - name: Verify Android SDK
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME"
          ls -la $ANDROID_HOME/platforms || true

      - name: Cache Bazel external dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/bazel
          key: ${{ runner.os }}-bazel-${{ hashFiles('WORKSPACE', 'MODULE.bazel', '**/BUILD') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      # 修复 BUILD 文件中错误的 load 路径（基于之前经验）
      - name: Patch BUILD file to use correct rules_java load path
        run: |
          sed -i 's|//third_party/bazel_rules/rules_java/java:defs.bzl|@rules_java//java:defs.bzl|' tensorflow_lite_support/java/BUILD
          echo "Patched BUILD file:"
          grep -n "rules_java" tensorflow_lite_support/java/BUILD || true

      # 关键：参考 .bazelrc 配置，正确初始化 Python 工具链
      - name: Configure TensorFlow for Python
        run: |
          if [ -f ./configure.py ]; then
            export HERMETIC_PYTHON_VERSION=3.12
            export PYTHON_BIN_PATH=$(which python3)
            export PYTHON_LIB_PATH=$($PYTHON_BIN_PATH -c "import site; print(site.getsitepackages()[0])")
            # 明确禁用不需要的选项，避免配置脚本询问
            export TF_NEED_CUDA=0
            export TF_NEED_ROCM=0
            export TF_NEED_CLANG=0
            export TF_NEED_OPENCL_SYCL=0
            export TF_NEED_TENSORRT=0
            export TF_SET_ANDROID_WORKSPACE=1  # 需要 Android 工作区
            export TF_DOWNLOAD_CLANG=0
            export TF_ENABLE_XLA=0
            # 使用 'yes' 自动接受所有默认值
            yes "" | python3 ./configure.py
          else
            echo "No configure.py found, skipping"
          fi

      # 关键：显式使用 Android 配置进行构建，匹配 .bazelrc 中的定义
      - name: Build TFLite Support AAR
        run: |
          bazel build //tensorflow_lite_support/java:tensorflow-lite-support \
            --curses=no \
            --show_timestamps \
            --verbose_failures

      - name: Locate AAR file
        id: locate-aar
        run: |
          AAR_PATH=$(find bazel-bin/tensorflow_lite_support/java -name "*.aar" | head -n 1)
          if [ -z "$AAR_PATH" ]; then
            echo "Error: AAR not found!"
            exit 1
          fi
          echo "aar-path=$AAR_PATH" >> "$GITHUB_OUTPUT"
          echo "Found AAR at $AAR_PATH"

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-android-aar
          path: ${{ steps.locate-aar.outputs.aar-path }}
          if-no-files-found: error

      - name: List output files
        run: find bazel-bin/tensorflow_lite_support/java -type f || true
