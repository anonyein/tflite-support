name: Build tflite-support Android AAR (官方指南 + sync)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Android SDK 和 NDK 环境变量
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_HOME: /usr/local/lib/android/sdk
      ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.0.0
      ANDROID_SDK_API_LEVEL: "23"
      ANDROID_NDK_API_LEVEL: "21"
      ANDROID_BUILD_TOOLS_VERSION: "30.0.3"
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

    steps:
      - name: Checkout tflite-support repository
        uses: actions/checkout@v4
        with:
          repository: anonyein/tflite-support
          ref: master
          path: tflite-support

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 安装 Bazelisk（二进制方式，避免 npm 权限问题）
      - name: Install Bazelisk
        run: |
          wget -q https://github.com/bazelbuild/bazelisk/releases/download/v1.20.0/bazelisk-linux-amd64 -O bazelisk
          chmod +x bazelisk
          sudo mv bazelisk /usr/local/bin/bazel

      - name: Set up Android SDK and NDK
        run: |
          mkdir -p $ANDROID_HOME/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip -d $ANDROID_HOME/cmdline-tools
          mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          yes | sdkmanager --licenses
          sdkmanager "platforms;android-$ANDROID_SDK_API_LEVEL" "build-tools;$ANDROID_BUILD_TOOLS_VERSION"
          wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
          unzip -q android-ndk-r27-linux.zip -d /tmp
          sudo mv /tmp/android-ndk-r27 $ANDROID_NDK_HOME

      - name: Clone TensorFlow (required by tflite-support WORKSPACE)
        working-directory: tflite-support
        run: |
          git clone --recursive https://github.com/tensorflow/tensorflow.git tensorflow_src
          cd tensorflow_src
          git checkout 777924f5575e7e6e22e4f47be211c2a94f59c4f5
          git submodule update --init --recursive

      - name: Configure TensorFlow (生成 .tf_configure.bazelrc)
        working-directory: tflite-support/tensorflow_src
        run: |
          export TF_NEED_ANDROID=1
          export TF_SET_ANDROID_WORKSPACE=1
          yes '' | python3 configure.py

      # 关键修复：创建 unused 文件并执行 bazel sync 确保覆盖生效
      - name: Prepare TensorFlow source and sync
        working-directory: tflite-support
        run: |
          cd tensorflow_src
          # 创建 unused 文件（根目录和 xla 子目录，解决 vendoring 错误）
          touch unused
          if [ -d xla ]; then touch xla/unused; fi
          # 可选：修补 repo.bzl 中的 vendoring 路径问题（增加健壮性）
          sed -i '/ctx.symlink(ctx.path(ctx.attr._root).dirname.get_child(ctx.attr.path), ".")/c\
              # Patched to handle paths with slashes\n    path_parts = ctx.attr.path.split('\''/'\'')\n    p = ctx.path(ctx.attr._root).dirname\n    for part in path_parts:\n        p = p.get_child(part)\n    ctx.symlink(p, ".")' third_party/repo.bzl || true
          cd ..

          # 执行 sync 以确保覆盖生效
          bazel sync --configure \
            --override_repository=org_tensorflow=$(pwd)/tensorflow_src \
            --repo_env=HERMETIC_PYTHON_VERSION=3.12 \
            --repo_env=PYTHON_BIN_PATH=/usr/bin/python3 \
            --repo_env=TF_PYTHON_VERSION=3.12

      - name: Build tflite-support AAR
        working-directory: tflite-support
        run: |
          bazel build //tensorflow_lite_support/java:tensorflow-lite-support \
            -c opt \
            --fat_apk_cpu=arm64-v8a,armeabi-v7a,x86,x86_64 \
            --host_crosstool_top=@bazel_tools//tools/cpp:toolchain \
            --override_repository=org_tensorflow=$(pwd)/tensorflow_src \
            --verbose_failures

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: tflite-support-aar
          path: tflite-support/bazel-bin/tensorflow_lite_support/java/*.aar
